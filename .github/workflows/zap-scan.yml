name: ZAP Scan on Juice Shop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap_against_juice_shop:
    runs-on: windows-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Start Juice Shop (Docker)
      run: |
        docker pull bkimminich/juice-shop:latest
        docker run --name juice-shop -d -p 3000:3000 bkimminich/juice-shop:latest

    - name: Wait for Juice Shop to be reachable
      run: |
        echo "Waiting for Juice Shop on http://localhost:3000 ..."
        for i in $(seq 1 30); do
          if curl -sSf http://localhost:3000/ > /dev/null; then
            echo "Juice Shop is up!"
            exit 0
          fi
          echo "not up yet ($i) â€” sleeping 2s"
          sleep 2
        done
        echo "Juice Shop did not start in time" && exit 1

    - name: Run ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.15.0
      with:
        target: "http://localhost:3000"
        cmd_options: "-a -t http://localhost:3000 -r zap-report.html"
        artifact_name: "zap-baseline-report"
      timeout-minutes: 30

    - name: Upload ZAP HTML report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: ./zap-report.html

    - name: Stop Juice Shop
      if: always()
      run: |
        docker logs juice-shop --tail 200 || true
        docker rm -f juice-shop || true
